# Image Description Viewer

A Qt6-based desktop application for browsing and viewing image descriptions generated by the Image Description Toolkit workflow.

## Features

- **Accessible Navigation**: Browse image descriptions with full screen reader support
- **Image Preview**: View full-size images alongside their descriptions
- **Clipboard Integration**: Copy descriptions, image file paths, or images to clipboard
- **AI Redescription**: Generate new descriptions using different models and fully customizable prompts
  - Real-time model detection from your Ollama installation
  - Visual status indicators (‚è≥ processing, üîÑ updated) 
  - Editable prompt text with predefined styles or custom prompts
  - Background processing with progress tracking
  - Screen reader announcements for accessibility
- **Keyboard Navigation**: Full keyboard and tab navigation support

## Installation

The viewer requires PyQt6, which can be installed with:

```bash
pip install PyQt6
```

Or if using the project's virtual environment, PyQt6 is already included in the requirements.

## Usage

### Starting the Viewer

Run the viewer application:

```bash
python viewer/image_viewer.py
```

### Loading a Workflow Output

1. Activate the **"Change Directory"** button
2. Navigate to and select a completed workflow output directory (e.g., `workflow_moondream_narrative_20250901_223412`)
3. The viewer will automatically parse the HTML report and load all images and descriptions

### Navigation

- **List Navigation**: Use arrow keys or mouse to select images in the left panel
- **Tab Navigation**: Press Tab to cycle through all focusable elements including the image preview
- **Keyboard Shortcuts**: Standard Qt keyboard navigation applies

### Accessibility Features

- **Screen Reader Support**: Each list item contains the full image description as accessible text
- **Visual Truncation**: List items show only filenames visually to keep the interface clean
- **Tooltips**: Hover over list items to see the full description
- **Tab Focus**: All elements including the image preview can receive keyboard focus

### Clipboard Operations

- **Copy Description**: Copies the full text description to clipboard
- **Copy Image Path**: Copies the full file path of the selected image to clipboard
- **Copy Image**: Copies the actual image data to clipboard for pasting into other applications

### AI Redescription

The Redescribe feature allows you to generate new descriptions for any image using different AI models and customizable prompts. This feature integrates seamlessly with the existing Image Description Toolkit scripts without modifying them.

#### How to Use Redescribe

1. **Select an Image**: Click on any image in the left panel
2. **Click Redescribe**: Press the "Redescribe" button in the bottom toolbar
3. **Configure Options**: In the dialog that opens:
   - **Model Selection**: Choose from available Ollama models on your system
   - **Prompt Style**: Select a predefined style (detailed, concise, narrative, etc.)
   - **Custom Prompt**: View and edit the actual prompt text that will be sent to the AI
4. **Start Processing**: Click "OK" to begin redescription

#### Visual Status Indicators

The viewer provides clear feedback during the redescription process:

- **‚è≥ Processing**: Shows while the AI is generating a new description
- **üîÑ Updated**: Marks images that have been successfully redescribed
- **Status Bar**: Displays progress messages and completion notifications
- **Prevention System**: Blocks multiple simultaneous requests on the same image

#### Advanced Features

- **Prompt Editing**: View and modify the complete prompt text before submission
- **Custom Prompts**: Create entirely custom prompts or modify existing ones
- **Model Detection**: Automatically detects all available Ollama models
- **Background Processing**: Long descriptions run without freezing the interface
- **Status Tracking**: Clear visual and accessible feedback for screen readers
- **Error Handling**: Graceful handling of model or connection issues

#### Accessibility Support

- **Screen Reader Announcements**: Status changes are announced to assistive technology
- **Keyboard Navigation**: Tab through dialog elements, Tab key moves focus instead of inserting tabs in prompt box
- **Accessible Labels**: All controls have appropriate accessible names and descriptions
- **Processing Announcements**: Screen readers announce "Processing: [description]" for active redescriptions

#### Requirements for Redescription

- **Ollama**: Must be installed and running (`ollama serve`)
- **Vision Models**: At least one vision model must be available:
  ```bash
  ollama pull moondream        # Lightweight, fast
  ollama pull llava:7b         # Balanced performance
  ollama pull llama3.2-vision:11b  # High quality
  ```
- **Dependencies**: The viewer uses the existing `scripts/image_describer.py` and configuration files

#### Technical Integration

The Redescribe feature works by:
1. **Importing** the existing `ImageDescriber` class from `scripts/image_describer.py`
2. **Using** configuration from `scripts/image_describer_config.json`
3. **Calling** the same `describe_image()` methods used by command-line workflows
4. **Preserving** all original functionality - no scripts are modified

This approach ensures compatibility with existing workflows while providing a user-friendly GUI interface.

## Interface Layout

The viewer uses a split-panel layout:

- **Left Panel**: List of images with status indicators (max width 400px)
  - Image filenames for visual clarity
  - ‚è≥ emoji for images currently being processed
  - üîÑ emoji for images with updated descriptions
  - Full descriptions available to screen readers
- **Right Panel**: 
  - Image preview area (scalable, maintains aspect ratio)
  - Full description text box (read-only)
  - Action buttons: Copy Description, Copy Image Path, Copy Image, Redescribe
- **Status Bar**: Progress messages and completion notifications

## Supported Formats

The viewer works with workflow output directories that contain:
- `html_reports/image_descriptions.html` - Main data source
- Images in various subdirectories (converted_images, extracted_frames, etc.)

## Technical Notes

- Built with PyQt6 for modern Qt support
- Parses HTML reports using regex patterns
- Handles HTML entity decoding automatically
- Scales images while preserving aspect ratios
- Uses Qt's accessibility framework for screen reader support

## Troubleshooting

**App won't start**: Ensure PyQt6 is installed and you're using Python 3.8+

**No images/descriptions load**: Verify the selected directory contains `html_reports/image_descriptions.html`

**Redescribe button not working**: 
- Check that Ollama is running (`ollama serve` in terminal)
- Verify vision models are installed (`ollama list` to see available models)
- Install a vision model if none available (`ollama pull moondream`)

**No models in dropdown**: Ensure Ollama service is running and has vision-capable models installed

**Redescribe gets stuck on processing**: 
- Check Ollama logs for errors
- Verify the model isn't out of memory
- Try a smaller model like `moondream` for faster processing

**Status indicators not updating**: The viewer automatically updates status - if stuck, restart the application

**Clipboard not working**: Some clipboard operations may require the app to have focus in your window manager

**Images not displaying**: Check that image files exist in the expected subdirectories and aren't corrupted

**Redescribe button disabled/not working**: 
- Ensure Ollama is installed and running (`ollama serve`)
- Verify you have vision models installed (`ollama list`)
- Check that the scripts directory is accessible from the viewer location

**Redescribe fails with "Model not available"**: Install the desired model with `ollama pull <model-name>`
