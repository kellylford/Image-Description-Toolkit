# Image Description Viewer

A Qt6-based desktop application for browsing and viewing image descriptions generated by the Image Description Toolkit workflow. Features both live monitoring of active workflows and viewing of completed workflow outputs.

## Features

- **Live Workflow Monitoring**: Monitor active workflows in real-time with progress tracking
- **Accessible Navigation**: Browse image descriptions with full screen reader support
- **Smart Focus Management**: Navigation is never interrupted by automatic updates
- **Image Preview**: View full-size images alongside their descriptions
- **Clipboard Integration**: Copy descriptions, image file paths, or images to clipboard
- **AI Redescription**: Generate new descriptions using different models and fully customizable prompts
  - Real-time model detection from your Ollama installation
  - Visual status indicators (‚è≥ processing, üîÑ updated) 
  - Editable prompt text with predefined styles or custom prompts
  - Background processing with progress tracking
  - Screen reader announcements for accessibility
- **Keyboard Navigation**: Full keyboard and tab navigation support
- **Real-Time Progress**: Title bar shows current progress for screen reader accessibility

## Installation

The viewer requires PyQt6, which can be installed with:

```bash
pip install PyQt6
```

Or if using the project's virtual environment, PyQt6 is already included in the requirements.

## Usage

### Starting the Viewer

Run the viewer application:

```bash
python viewer/viewer.py
```

### Loading a Workflow Output

#### Method 1: Browse Results (Recommended)

1. Click the **"Browse Results"** button
2. The viewer will automatically detect workflow directories in common locations:
   - `<installation_dir>/Descriptions/`
   - `../Descriptions/` (one level up, then down)
   - `C:/idt/Descriptions` (common Windows location)
3. A dialog appears showing all available workflows in a table:
   - **Name**: Workflow name
   - **Provider**: AI provider (ollama, openai, claude)
   - **Model**: Model name
   - **Prompt**: Prompt style used
   - **Descriptions**: Number of descriptions generated
   - **Timestamp**: When workflow was run
4. Navigate using:
   - **Arrow Keys**: Move up/down through workflows
   - **Enter**: Open selected workflow
   - **Double-Click**: Open selected workflow
   - **Browse Directory Button**: Manually select a different directory
5. Click **"Open Workflow"** or press Enter to load

**Benefits:**
- See all workflows at a glance
- Know how many descriptions before opening
- See when each workflow was run
- Keyboard-driven for efficiency
- Automatically finds your workflow directories

#### Method 2: Change Directory (Manual)

1. Click the **"Change Directory"** button
2. Navigate to and select a workflow output directory:
   - For completed workflows: Look for directories with `html_reports/` folder
   - For active workflows: Look for descriptions/` folder
3. The viewer will automatically detect the appropriate mode:
   - **HTML Mode**: For completed workflows with final reports
   - **Live Mode**: For active workflows (auto-suggested if HTML not available)

### Live Mode Features

**Live Mode** allows you to monitor workflows while they're still running:

#### Enabling Live Mode
- Check the **"Live Mode"** checkbox after loading a workflow directory
- The viewer will immediately start showing real-time progress
- Title bar updates to show progress: "Processing: X of Y images (Live)"

#### Live Mode Benefits
- **Real-time feedback** on long-running workflows
- **Quality control** during processing - review descriptions as they're generated
- **Progress visibility** with screen reader support
- **Early problem detection** if descriptions aren't as expected
- **Multitasking** - review completed work while processing continues

#### Smart Updates
- **15-Second Automatic Refresh**: Checks for new descriptions (non-intrusive)
- **Focus Preservation**: Never interrupts your navigation or reading
- **Incremental Loading**: Only new entries are added, your position is preserved
- **Manual Refresh**: Click "Refresh" button for immediate updates with position preservation

#### Accessibility in Live Mode
- **Screen Reader Support**: Progress updates announced in title bar
- **No Focus Stealing**: Updates happen only when you're not actively navigating
- **Position Memory**: Cursor position maintained in description text during updates
- **Smart Detection**: Defers updates if you're actively reading or navigating

### Navigation

- **List Navigation**: Use arrow keys or mouse to select images in the left panel
- **Tab Navigation**: Press Tab to cycle through all focusable elements including the image preview
- **Keyboard Shortcuts**: Standard Qt keyboard navigation applies

### Accessibility Features

- **Screen Reader Support**: Each list item contains the full image description as accessible text
- **Visual Truncation**: List items show only filenames visually to keep the interface clean
- **Tooltips**: Hover over list items to see the full description
- **Tab Focus**: All elements including the image preview can receive keyboard focus

### Clipboard Operations

- **Copy Description**: Copies the full text description to clipboard
- **Copy Image Path**: Copies the full file path of the selected image to clipboard  
- **Copy Image**: Copies the actual image data to clipboard for pasting into other applications

### Live Mode Controls

| Control | Function |
|---------|----------|
| **Browse Results** | Open workflow browser to select from available workflows |
| **Live Mode Checkbox** | Toggle between live monitoring and final HTML viewing |
| **Refresh Button** | Manually update live content while preserving your position |
| **Change Directory** | Load a different workflow output directory |

### Workflow Browser

The **Browse Results** dialog provides a convenient way to view and select from all available workflows:

#### Features
- **Auto-Detection**: Automatically finds workflow directories
- **Sortable Columns**: Click column headers to sort
- **Keyboard Navigation**: Use arrow keys to browse
- **Quick Selection**: Double-click or press Enter to open
- **Manual Override**: Browse button for custom locations

#### Keyboard Shortcuts in Browser
- **Arrow Keys**: Navigate up/down through workflows
- **Enter**: Open selected workflow
- **Escape**: Cancel and close dialog
- **Tab**: Move between Browse button and OK/Cancel

### Standard Controls  

| Control | Function |
|---------|----------|
| **Copy Description** | Copy selected description to clipboard |
| **Copy Image Path** | Copy image file path to clipboard |
| **Copy Image** | Copy image to clipboard |
| **Redescribe** | Generate new description with different model |

### AI Redescription

The Redescribe feature allows you to generate new descriptions for any image using different AI models and customizable prompts. This feature integrates seamlessly with the existing Image Description Toolkit scripts without modifying them.

#### How to Use Redescribe

1. **Select an Image**: Click on any image in the left panel
2. **Click Redescribe**: Press the "Redescribe" button in the bottom toolbar
3. **Configure Options**: In the dialog that opens:
   - **Model Selection**: Choose from available Ollama models on your system
   - **Prompt Style**: Select a predefined style (detailed, concise, narrative, etc.)
   - **Custom Prompt**: View and edit the actual prompt text that will be sent to the AI
4. **Start Processing**: Click "OK" to begin redescription

#### Visual Status Indicators

The viewer provides clear feedback during the redescription process:

- **‚è≥ Processing**: Shows while the AI is generating a new description
- **üîÑ Updated**: Marks images that have been successfully redescribed
- **Status Bar**: Displays progress messages and completion notifications
- **Prevention System**: Blocks multiple simultaneous requests on the same image

#### Advanced Features

- **Prompt Editing**: View and modify the complete prompt text before submission
- **Custom Prompts**: Create entirely custom prompts or modify existing ones
- **Model Detection**: Automatically detects all available Ollama models
- **Background Processing**: Long descriptions run without freezing the interface
- **Status Tracking**: Clear visual and accessible feedback for screen readers
- **Error Handling**: Graceful handling of model or connection issues

#### Accessibility Support

- **Screen Reader Announcements**: Status changes are announced to assistive technology
- **Keyboard Navigation**: Tab through dialog elements, Tab key moves focus instead of inserting tabs in prompt box
- **Accessible Labels**: All controls have appropriate accessible names and descriptions
- **Processing Announcements**: Screen readers announce "Processing: [description]" for active redescriptions

#### Requirements for Redescription

- **Ollama**: Must be installed and running (`ollama serve`)
- **Vision Models**: At least one vision model must be available:
  ```bash
  ollama pull moondream        # Lightweight, fast
  ollama pull llava:7b         # Balanced performance
  ollama pull llama3.2-vision:11b  # High quality
  ```
- **Dependencies**: The viewer uses the existing `scripts/image_describer.py` and configuration files

#### Technical Integration

The Redescribe feature works by:
1. **Importing** the existing `ImageDescriber` class from `scripts/image_describer.py`
2. **Using** configuration from `scripts/image_describer_config.json`
3. **Calling** the same `describe_image()` methods used by command-line workflows
4. **Preserving** all original functionality - no scripts are modified

This approach ensures compatibility with existing workflows while providing a user-friendly GUI interface.

## Interface Layout

The viewer uses a split-panel layout:

- **Left Panel**: List of images with status indicators (max width 400px)
  - Image filenames for visual clarity
  - ‚è≥ emoji for images currently being processed
  - üîÑ emoji for images with updated descriptions
  - Full descriptions available to screen readers
- **Right Panel**: 
  - Image preview area (scalable, maintains aspect ratio)
  - Full description text box (read-only)
  - Action buttons: Copy Description, Copy Image Path, Copy Image, Redescribe
- **Status Bar**: Progress messages and completion notifications

## Supported Formats

The viewer works with workflow output directories that contain:

**For Live Mode** (active workflows):
- `descriptions/image_descriptions.txt` - Live description file that updates during processing
- `logs/image_describer_*.log` - Log files for progress tracking
- Images in various subdirectories (`temp_combined_images/`, `converted_images/`, `extracted_frames/`)

**For HTML Mode** (completed workflows):
- `html_reports/image_descriptions.html` - Final HTML report
- Images in various subdirectories (`converted_images/`, `extracted_frames/`, etc.)

The viewer automatically detects which mode to use based on available files.

## Technical Notes

- Built with PyQt6 for modern Qt support
- Parses HTML reports using regex patterns
- Handles HTML entity decoding automatically
- Scales images while preserving aspect ratios
- Uses Qt's accessibility framework for screen reader support

## Troubleshooting

**App won't start**: Ensure PyQt6 is installed and you're using Python 3.8+

**No images/descriptions load**: 
- For completed workflows: Verify the directory contains `html_reports/image_descriptions.html`
- For active workflows: Verify the directory contains `descriptions/image_descriptions.txt`
- Try enabling Live Mode if HTML report isn't available yet

**Live Mode not working**:
- Ensure the workflow directory contains `descriptions/image_descriptions.txt`
- Check that log files exist in `logs/image_describer_*.log`
- Try clicking "Refresh" manually to force an update

**Focus keeps jumping or being lost** (Fixed in current version):
- Automatic updates now preserve focus and position
- Updates only happen when you're NOT actively navigating
- Refresh interval increased to 15 seconds (less aggressive)
- Manual refresh preserves your exact position and focus

**Progress seems stuck in Live Mode**:
- Check if workflow is still active (recent entries in log files)
- Progress updates automatically every 15 seconds
- Use "Refresh" button for immediate updates
- Verify the workflow process is still running

**Images don't display in Live Mode**:
- Images are resolved from multiple possible locations automatically
- Most commonly found in `temp_combined_images/` directory
- May also be in `converted_images/` or `extracted_frames/`
- File paths are relative to the workflow directory

**Redescribe button not working**: 
- Check that Ollama is running (`ollama serve` in terminal)
- Verify vision models are installed (`ollama list` to see available models)
- Install a vision model if none available (`ollama pull moondream`)

**No models in dropdown**: Ensure Ollama service is running and has vision-capable models installed

**Redescribe gets stuck on processing**: 
- Check Ollama logs for errors
- Verify the model isn't out of memory
- Try a smaller model like `moondream` for faster processing

**Status indicators not updating**: The viewer automatically updates status - if stuck, restart the application

**Clipboard not working**: Some clipboard operations may require the app to have focus in your window manager

**Images not displaying**: Check that image files exist in the expected subdirectories and aren't corrupted

**Redescribe button disabled/not working**: 
- Ensure Ollama is installed and running (`ollama serve`)
- Verify you have vision models installed (`ollama list`)
- Check that the scripts directory is accessible from the viewer location

**Redescribe fails with "Model not available"**: Install the desired model with `ollama pull <model-name>`

## Development and Build Information

### Source Control Exclusions

The repository is configured to automatically exclude common build artifacts and workflow outputs from source control:

#### Automatically Ignored Files/Directories:
- **Workflow Output**: All `workflow_*` directories created when scripts run
- **Build Artifacts**: `build/`, `dist/`, `*.spec` files from PyInstaller
- **Python Cache**: `__pycache__/`, `*.pyc`, `.pytest_cache/`
- **Virtual Environments**: `.venv/`, `venv/`, `env/`
- **IDE Files**: `.vscode/`, `.idea/`, editor swap files
- **Log Files**: `*.log`, `logs/` directories
- **OS Files**: `.DS_Store`, `Thumbs.db`, etc.

#### Building Standalone Executables

Use `viewer/build_viewer.bat` to create standalone executables:
- Automatically detects system architecture (AMD64/ARM64)
- Creates separate builds for different architectures when possible
- Outputs to `dist/` directory with architecture-specific subdirectories
- All build outputs are automatically excluded from git

The build script handles:
- PyInstaller installation if needed
- Multi-architecture builds
- Dependency bundling
- README generation for each build
- Cleanup of temporary files
