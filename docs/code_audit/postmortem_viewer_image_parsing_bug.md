# Post-Mortem: Image Description File Parsing Bug

**Date:** 2026-01-14  
**Discovered:** During manual testing of viewer with multi-image workflows  
**Severity:** üî¥ HIGH (User-visible data loss - displays only 2 of 3 images)  
**Root Cause:** File format generation mismatch between writer and parser  
**Status:** FIXED

---

## Summary

The viewer displayed only 2 out of 3 images from the workflow:
- **Expected:** 3 images shown (img_0022.jpg, img_0023.jpg, img_0024.jpg)
- **Actual:** 2 images shown (img_0023.jpg, img_0024.jpg)
- **Missing:** img_0022.jpg (the first image)

**Root Cause Location:**
- **Writer:** `scripts/image_describer.py:1216` - header initialization
- **Parser:** `viewer/viewer_wx.py:996` - file parsing logic

---

## Technical Details

### The Bug

The `image_descriptions.txt` file is structured as:

```
Image Descriptions Generated by Ollama Vision Model
================================================================================
Generated on: 2026-01-14 15:58:58
Model used: moondream:latest
...config details...
================================================================================
[NO SEPARATOR LINE HERE]
File: input_images\img_0022.jpg
Path: ...
Description: ...
Timestamp: ...
--------------------------------------------------------------------------------

File: input_images\img_0023.jpg
...
--------------------------------------------------------------------------------

File: input_images\img_0024.jpg
...
--------------------------------------------------------------------------------
```

**The Parser** (before fix):
```python
separator = '-' * 80
sections = content.split(separator)

for section in sections[1:]:  # ‚ö†Ô∏è SKIPS SECTION 0
    desc = self.parse_entry(section.strip())
```

When split by the 80-dash separator:
- **sections[0]** = Header + img_0022 entry (SKIPPED by `[1:]`)
- **sections[1]** = img_0023 entry ‚úì
- **sections[2]** = img_0024 entry ‚úì
- **sections[3]** = Empty

**Result:** img_0022 was never parsed because it was in sections[0], which the parser explicitly skipped.

---

## Why This Bug Slipped Through

### What the Audit Did NOT Check
1. **No End-to-End Workflow Testing**
   - Audit analyzed code statically for config loading, imports, duplicate code
   - Did NOT run actual workflows to generate real output
   - Did NOT load generated files into the viewer to test parsing

2. **No Data Format Validation**
   - Focus was on Python code quality (CRITICAL config loading bugs)
   - File format generation bugs require runtime testing to catch
   - Parser assumptions (separator at beginning of first entry) were not verified

3. **No Multi-Image Testing**
   - Single-image workflows would show 1 image and appear to work fine
   - Bug only manifests with 2+ images (missing first image)
   - The test data may not have included multi-image workflows

### What Should Have Caught This
- **Developer integration test:** Run `idt workflow <images>` then open in viewer, count images
- **QA checklist:** "Verify number of images in workflow matches viewer display count"
- **Automated test:** Parse generated file, assert count matches input image count

---

## The Fix

### Part 1: File Format Generation (PREVENTATIVE)
**File:** `scripts/image_describer.py:1216`

**Before:**
```python
f.write("=" * 80 + "\n\n")
# Next: First description entry (no separator before it)
```

**After:**
```python
f.write("=" * 80 + "\n")
# Add separator line before first description entry so it's properly delimited
f.write("-" * 80 + "\n\n")
```

This ensures the file structure is:
```
Header
================================================================================
--------------------------------------------------------------------------------
File: img_0022.jpg
...
```

Now ALL image entries are preceded by a separator line, matching the parser's expectations.

### Part 2: Parser Robustness (DEFENSIVE)
**File:** `viewer/viewer_wx.py:996`

**Before:**
```python
for section in sections[1:]:  # Skip section 0 (header)
    if not section.strip():
        continue
    desc = self.parse_entry(section.strip())
    if desc:
        descriptions.append(desc)
```

**After:**
```python
for section in sections:  # Parse ALL sections
    if not section.strip():
        continue
    
    # Skip sections that are pure header with no image entries
    # Pure headers contain metadata but no "File:" entries for actual images
    section_lower = section.lower()
    if ('image descriptions generated' in section_lower and 'file:' not in section_lower):
        continue
    
    desc = self.parse_entry(section.strip())
    if desc:
        descriptions.append(desc)
```

This handles both old files (where img_0022 is in section[0] with header) and new files (where it's in its own section).

---

## Testing

Verified with test workflow: `wf_pictures_brewers2022posedphoto_ollama_moondreamlatest_narrative_20260114_155854`

**Before Fix:**
```
Section 0: Has image (img_0022) - SKIPPED by [1:]
Section 1: Has image (img_0023) - PARSED ‚úì
Section 2: Has image (img_0024) - PARSED ‚úì
Result: 2 images shown
```

**After Parser Fix (without file format fix):**
```
Section 0: Has image (img_0022) - NOW PARSED ‚úì
Section 1: Has image (img_0023) - PARSED ‚úì
Section 2: Has image (img_0024) - PARSED ‚úì
Result: 3 images shown
```

**After Both Fixes (going forward):**
New files will have proper separator before img_0022, making the structure cleaner.

---

## Lessons Learned

### For Code Quality
1. **Data format bugs are invisible to static analysis**
   - Config loading bugs: Code review catches them
   - Parser bugs: Need runtime testing with real data

2. **File format assumptions must be tested**
   - "Separator at beginning of each entry" was implicit in code
   - Should be explicit in documentation and tests

3. **Multi-image workflows are critical test case**
   - Single-image workflows can hide first-image bugs
   - Must test with 3+ images minimum

### For Future Audits
- **Add integration test phase** after fixing CRITICAL code issues
- **Test data requirements:** Multi-image workflows, edge cases
- **File format validation:** Verify round-trip (write ‚Üí read ‚Üí verify counts)
- **End-to-end scenarios:** Workflow generation ‚Üí viewer parsing ‚Üí count verification

---

## Files Modified

| File | Change | Lines |
|------|--------|-------|
| `scripts/image_describer.py` | Add separator after header | 1216 |
| `viewer/viewer_wx.py` | Parse all sections robustly | 996-1014 |

---

## Deployment Notes

‚úÖ **Both fixes are backward compatible:**
- Old files (missing initial separator): Viewer fix handles them
- New files (with initial separator): Both code paths work identically
- No database migrations or config changes needed
- Safe to deploy immediately

