# Gallery Replication Guide

**Create a new image gallery from scratch - repeatable process**

This guide provides step-by-step instructions for creating a new image gallery using the IDT workflow. All steps are concrete commands you can copy and run.

**See also:** [ARCHITECTURE.md](ARCHITECTURE.md) for technical details and troubleshooting.

---

## Prerequisites

### Tools Required
- `idt.exe` installed at `c:/idt/idt.exe`
- Python 3.x with `requests` package
- Claude API key in `~/.config/idt/claude.txt`
- 15-30 source images (JPG format recommended)

### Before You Start
1. Choose a project name (e.g., `beach2024`, `europetrip`)
2. Prepare 15-30 images in a source directory
3. Verify IDT is working: `c:/idt/idt.exe --version`

### Directory Structure
```
tools/ImageGallery/
├── yourproject/           # New gallery directory
│   ├── images/           # Source images (you copy these)
│   ├── descriptions/     # Generated by IDT workflows + scripts
│   └── index.html        # Copy from parent, configure
```

---

## Step-by-Step Process

### Phase 1: Image Selection & Preparation

#### Option A: Manual Selection (Simple)
1. Create project directory:
   ```bash
   cd tools/ImageGallery
   mkdir myproject
   mkdir myproject/images
   ```

2. Copy your images:
   ```bash
   # Copy 20-30 images to myproject/images/
   cp /path/to/your/photos/*.jpg myproject/images/
   ```

#### Option B: AI-Powered Selection (Advanced)
For large collections (500+ images), use the AI selection tool:

1. **Modify `select_best_images.py`** for your source:
   ```python
   # Line ~20: Update workflow pattern
   WORKFLOW_PATTERN = 'yourproject'  # Change from 'europe'
   
   # Line ~30: Update workflow paths
   workflow_dirs = [
       '//qnap/home/idt/descriptions/wf_yourproject_*'
   ]
   ```

2. **Run selection**:
   ```bash
   cd tools/ImageGallery/yourproject
   python ../select_best_images.py
   # Generates: selection_report.txt, selected_images.json
   ```

3. **Copy selected images**:
   ```bash
   python copy_selected_images.py
   # Reads selected_images.json and copies files
   ```

**Expected Result:** `images/` directory with 20-30 JPG files

---

### Phase 2: Generate Descriptions

#### Step 2.1: Determine Your Model

**Find available Claude models** (if unsure):
```bash
# Check your existing workflows for working model names
grep "model:" //qnap/home/idt/descriptions/wf_*/workflow_metadata.json | head -5
```

**Known Working Models (as of Oct 2025):**
- `claude-3-haiku-20240307` - Fast, economical (RECOMMENDED for testing)
- `claude-3-5-haiku-20241022` - Current Haiku
- `claude-opus-4-20250514` - Highest quality
- `claude-sonnet-4-5-20250929` - Balanced

#### Step 2.2: Run All 4 Workflows

**Set up API key** (do once per terminal session):
```bash
export ANTHROPIC_API_KEY=$(cat ~/.config/idt/claude.txt)
```

**Run workflows** (execute all 4 commands):
```bash
cd tools/ImageGallery/yourproject

# 1. Narrative prompt (~2 min for 25 images)
c:/idt/idt.exe workflow images \
  --provider claude \
  --model claude-3-haiku-20240307 \
  --prompt-style narrative \
  --name yourproject \
  --output-dir descriptions \
  --api-key-file ~/.config/idt/claude.txt \
  --batch

# 2. Colorful prompt
c:/idt/idt.exe workflow images \
  --provider claude \
  --model claude-3-haiku-20240307 \
  --prompt-style colorful \
  --name yourproject \
  --output-dir descriptions \
  --api-key-file ~/.config/idt/claude.txt \
  --batch

# 3. Technical prompt
c:/idt/idt.exe workflow images \
  --provider claude \
  --model claude-3-haiku-20240307 \
  --prompt-style technical \
  --name yourproject \
  --output-dir descriptions \
  --api-key-file ~/.config/idt/claude.txt \
  --batch

# 4. Detailed prompt
c:/idt/idt.exe workflow images \
  --provider claude \
  --model claude-3-haiku-20240307 \
  --prompt-style detailed \
  --name yourproject \
  --output-dir descriptions \
  --api-key-file ~/.config/idt/claude.txt \
  --batch
```

**Expected Results:**
- 4 workflow directories in `descriptions/wf_yourproject_*`
- Each contains `descriptions/image_descriptions.txt`
- ~30KB-50KB per description file
- Total time: ~8 minutes for 25 images

**Verify success:**
```bash
ls -lh descriptions/wf_*/descriptions/image_descriptions.txt
# Should show 4 files, all >30KB
```

---

### Phase 3: Generate Gallery Data

#### Step 3.1: Convert to JSON

**Important:** The workflow directories are large (logs, temp files). The gallery only needs the small JSON files.

```bash
cd tools/ImageGallery/yourproject

# Generate JSON files to separate directory
python ../generate_descriptions.py \
  --descriptions-dir descriptions \
  --output-dir gallery-data \
  --pattern yourproject
```

**What This Does:**
- Scans `descriptions/wf_*` directories for description files
- Extracts descriptions and metadata
- Creates one JSON file per provider+model+prompt combination
- Writes to NEW `gallery-data/` directory (not mixing with workflows)
- Creates `index.json` listing all available configurations

**Expected Output:**
```
Found 4 description files generated
Output directory: gallery-data
Writing: claude_claude-3-haiku-20240307_narrative.json
Writing: claude_claude-3-haiku-20240307_colorful.json
Writing: claude_claude-3-haiku-20240307_technical.json
Writing: claude_claude-3-haiku-20240307_detailed.json
Writing: index.json
```

**Files created in `gallery-data/`:**
- `claude_claude-3-haiku-20240307_narrative.json` (~25-35KB)
- `claude_claude-3-haiku-20240307_colorful.json` (~35-45KB)
- `claude_claude-3-haiku-20240307_technical.json` (~40-50KB)
- `claude_claude-3-haiku-20240307_detailed.json` (~35-45KB)
- `index.json` (~500 bytes)

**Size Comparison:**
- `descriptions/` with workflows: **~130MB** (workflows + JSON)
- `gallery-data/` JSON only: **~150KB** (just what gallery needs)
- **You save 99.9% by using separate directory!**

**Verify:**
```bash
ls -lh gallery-data/*.json
# Should show 5 JSON files, 4 large ones and small index.json

du -sh descriptions/    # Large (workflows)
du -sh gallery-data/    # Small (JSON only)
```

---

### Phase 4: Generate Alt Text

#### Step 4.1: Run Alt Text Generation

```bash
cd tools/ImageGallery/yourproject

export ANTHROPIC_API_KEY=$(cat ~/.config/idt/claude.txt)

python ../generate_alt_text.py --jsondata-dir gallery-data/
```

**What This Does:**
- Reads all JSON files in `gallery-data/`
- For each unique image, generates concise alt text using Claude API
- Uses narrative descriptions as source
- Adds `alt_text` field to all JSON files
- Creates `.json.bak` backup files first

**Expected Output:**
```
======================================================================
Image Gallery Consistent Alt Text Generator
======================================================================

Collecting all images across configurations...
Found X images across Y configurations

Generating consistent alt text for all images...
[1/X] image1.jpg
  ✓ Generated alt text

[2/X] image2.jpg
  ✓ Generated alt text

...

Applying alt text to all configurations...
  ✓ Processing claude_claude-3-haiku-20240307_narrative.json
  ✓ Processing claude_claude-3-haiku-20240307_colorful.json
  ✓ Processing claude_claude-3-haiku-20240307_technical.json
  ✓ Processing claude_claude-3-haiku-20240307_detailed.json

======================================================================
Consistent alt text generation complete!
======================================================================
```

**Time:** ~2-3 minutes for 25 images

**Cost:** ~$0.10-0.20 USD (Claude Haiku pricing)

**Verify:**
```bash
# Check that alt text was added
grep -c "alt_text" gallery-data/claude_claude-3-haiku-20240307_narrative.json
# Should show 25 (or however many images you have)
```

**Note:** Backup files (`*.json.bak`) are created automatically. If something goes wrong, restore with:
```bash
cd gallery-data
for f in *.json.bak; do cp "$f" "${f%.bak}"; done
```

---

### Phase 5: Deploy Gallery

#### Step 5.1: Copy Gallery HTML

```bash
cp ../index.html .
```

#### Step 5.2: Update Configuration

Edit `index.html` line ~1010:

```javascript
const CONFIG = {
    imagesBaseUrl: './images/',
    descriptionsBaseUrl: './gallery-data/',  // Points to JSON directory
    workflowPattern: 'yourproject'           // Change this!
};
```

**Critical:** `descriptionsBaseUrl` must point to where the JSON files are (not workflow directories)

#### Step 5.3: Verify Structure

Before testing, verify you have the right structure:

```bash
ls -la
```

**Should show:**
```
yourproject/
├── index.html              # Gallery interface
├── images/                 # Image files (~50-100MB)
│   └── *.jpg
├── gallery-data/           # JSON files (~150KB)
│   ├── *.json             # Configuration files
│   └── index.json         # Master index
└── descriptions/           # Workflow data (NOT needed for gallery)
    └── wf_*/              # ~130MB - keep for regeneration
```

**For deployment, you only need:**
- `index.html`
- `images/`
- `gallery-data/`

**Size check:**
```bash
du -sh index.html images/ gallery-data/
# Should be ~50-100MB total for deployment

du -sh descriptions/
# ~130MB - NOT needed on web server
```

#### Step 5.4: Test Locally

```bash
# Start local server
python -m http.server 8082

# Open browser to: http://localhost:8082
```

---

## Verification Checklist

Before declaring success, verify:

- [ ] All 4 workflow directories exist in `descriptions/`
- [ ] Each workflow has `descriptions/image_descriptions.txt` >30KB
- [ ] `gallery-data/` contains 5 JSON files (4 configs + index.json)
- [ ] Each JSON file has ~25 entries (one per image)
- [ ] Alt text exists in all JSON files: `grep -c "alt_text" gallery-data/*.json`
- [ ] Gallery loads without console errors
- [ ] All images display correctly
- [ ] All 4 prompt descriptions appear for each image
- [ ] Image Browser mode works
- [ ] Description Explorer mode works
- [ ] Keyboard navigation works (arrows, Alt+P/Alt+N)

---

## Optional: Export Analysis Data

To export workflow data for analysis (timing, tokens, costs):

```bash
# Copy the export script
cp ../export_analysis_data.py .

# Run export
python export_analysis_data.py \
  --descriptions-dir descriptions \
  --output-dir analysis \
  --pattern yourproject

# Generates: analysis/image_analysis_data_YYYYMMDD_HHMMSS.csv
```

**CSV contains per-image data:**
- Provider, model, prompt style
- Processing time
- Token usage (input/output)
- Estimated costs
- Timestamps
- File sizes

**Use for:**
- Comparing model performance
- Cost analysis
- Speed benchmarking
- Token usage patterns

---

## Common Issues & Solutions

### Issue: "Model not found" (404 error)

**Symptom:** Workflow fails with "not_found_error"

**Cause:** Model name is incorrect or model retired

**Solution:**
```bash
# Check existing workflows for correct model names
grep "model:" //qnap/home/idt/descriptions/wf_*/workflow_metadata.json | head -10

# Use exact model name from working workflows
```

**Known Bad Names (as of Oct 2025):**
- ❌ `claude-sonnet-4` (wrong format)
- ❌ `claude-3-5-sonnet-20241022` (doesn't exist)

### Issue: API key not passing to subprocess

**Symptom:** "No API key" error even after setting ANTHROPIC_API_KEY

**Solution:** Always use `--api-key-file` option:
```bash
--api-key-file ~/.config/idt/claude.txt
```

### Issue: Gallery shows "No configurations found"

**Symptom:** Empty gallery, console shows loading errors

**Causes & Solutions:**
1. **Wrong workflowPattern in CONFIG**
   - Check: `workflowPattern: 'yourproject'` matches workflow directory names
   
2. **JSON files in wrong location**
   - Should be in `descriptions/`, not `jsondata/`
   - Run: `cp jsondata/*.json descriptions/`
   
3. **CORS error (file:// protocol)**
   - Must use HTTP server
   - Run: `python -m http.server 8082`

### Issue: Images don't display

**Symptom:** Broken image icons, 404 errors in console

**Solution:** Verify image paths
```bash
# Check CONFIG in index.html
imagesBaseUrl: './images/'  # Must match actual directory

# Verify images exist
ls images/*.jpg | wc -l
# Should match number in gallery
```

### Issue: Alt text generation script modifies wrong files

**Symptom:** Main gallery files get modified when testing new gallery

**Solution:** 
- Use the custom `add_alt_text.py` script above (works on current directory only)
- OR: Always run from the specific project directory
- **Never** use `../generate_alt_text.py` without verifying paths

---

## Time Estimates

For 25 images with Claude Haiku:

| Task | Time |
|------|------|
| Image selection (manual) | 15-30 min |
| Image selection (AI) | 5 min + tool creation |
| Run 4 workflows | 8-10 min |
| Generate JSON | 1 min |
| Generate alt text | 2-3 min |
| Deploy & test | 5-10 min |
| **Total (manual selection)** | **30-45 min** |
| **Total (AI selection, reusing tool)** | **15-20 min** |

---

## Batch Processing Multiple Galleries

To create multiple galleries efficiently:

### 1. Create Template Directory

```bash
cd tools/ImageGallery
mkdir _template
cp index.html _template/
cp contentprototype/add_alt_text.py _template/
```

### 2. Create Gallery from Template

```bash
# For each new gallery
GALLERY_NAME="beach2024"

cp -r _template $GALLERY_NAME
mkdir $GALLERY_NAME/images
# Copy your images to $GALLERY_NAME/images/

cd $GALLERY_NAME

# Update CONFIG in index.html
sed -i "s/yourproject/$GALLERY_NAME/g" index.html

# Run workflows (all 4 commands here)
# ... (see Phase 2)

# Generate JSON
python ../generate_descriptions.py --descriptions-dir descriptions --output-dir descriptions --pattern $GALLERY_NAME

# Generate alt text
python add_alt_text.py

# Test
python -m http.server 8083
```

---

## File Size Reference

Expected file sizes for 25-image gallery:

| File/Directory | Size | Notes |
|----------------|------|-------|
| `images/` | 50-100MB | Depends on image resolution |
| Each workflow directory | 500KB-2MB | Includes logs, temp files |
| Each `image_descriptions.txt` | 30-50KB | Raw descriptions |
| Each JSON file | 25-40KB | Formatted for gallery |
| `index.html` | 95KB | Gallery interface |
| **Total gallery** | **60-120MB** | Ready to deploy |

---

## Automation Script (Future)

For fully automated gallery creation:

```bash
#!/bin/bash
# create_gallery.sh - One command to rule them all

GALLERY_NAME=$1
IMAGES_DIR=$2
MODEL="claude-3-haiku-20240307"

if [ -z "$GALLERY_NAME" ] || [ -z "$IMAGES_DIR" ]; then
    echo "Usage: create_gallery.sh <name> <images_dir>"
    exit 1
fi

echo "Creating gallery: $GALLERY_NAME"

# Setup
mkdir -p "$GALLERY_NAME/images"
cp "$IMAGES_DIR"/*.jpg "$GALLERY_NAME/images/"
cp index.html "$GALLERY_NAME/"

cd "$GALLERY_NAME"

# Update config
sed -i "s/yourproject/$GALLERY_NAME/g" index.html

# Run workflows
export ANTHROPIC_API_KEY=$(cat ~/.config/idt/claude.txt)

for PROMPT in narrative colorful technical detailed; do
    echo "Running $PROMPT workflow..."
    c:/idt/idt.exe workflow images \
        --provider claude \
        --model $MODEL \
        --prompt-style $PROMPT \
        --name $GALLERY_NAME \
        --output-dir descriptions \
        --api-key-file ~/.config/idt/claude.txt \
        --batch
done

# Generate JSON
python ../generate_descriptions.py \
    --descriptions-dir descriptions \
    --output-dir descriptions \
    --pattern $GALLERY_NAME

# Generate alt text
python ../add_alt_text.py

echo "✅ Gallery created: $GALLERY_NAME"
echo "Test: cd $GALLERY_NAME && python -m http.server 8082"
```

**Usage:**
```bash
./create_gallery.sh vacation2024 /path/to/photos
```

---

## Best Practices

### Model Selection
- **Testing/Prototyping:** Use `claude-3-haiku-20240307` (fast, cheap)
- **Production:** Use `claude-opus-4-*` or `claude-sonnet-4-*` (better quality)
- **Budget-Conscious:** Haiku is excellent for most use cases

### Image Count
- **Sweet spot:** 20-30 images per gallery
- **Minimum:** 10 images (for meaningful comparison)
- **Maximum:** 50 images (avoid overwhelming users)
- **Multiple galleries:** Better than one huge gallery

### Prompt Selection
- **Always include:** narrative (baseline), detailed (comprehensive)
- **Optional:** colorful (artistic), technical (photography)
- **Custom:** Create your own in `scripts/image_describer_config.json`

### Quality Control
1. **Review first 5 descriptions** before processing all images
2. **Test with 10 images** before committing to full gallery
3. **Compare prompts** to ensure meaningful differences
4. **Check alt text** for accuracy and accessibility

---

## Maintenance

### Updating Descriptions
To regenerate descriptions (e.g., after model improvements):

```bash
cd tools/ImageGallery/yourproject

# Backup current descriptions
mv descriptions descriptions.backup

# Re-run workflows with new model
# ... (see Phase 2)

# Regenerate JSON and alt text
# ... (see Phase 3 & 4)
```

### Adding More Images
To expand existing gallery:

```bash
# Add new images to images/ directory
cp /path/to/new/*.jpg images/

# Re-run all workflows
# ... (workflows will process ALL images in directory)

# Regenerate JSON and alt text
```

### Changing Models
To add descriptions from different model:

```bash
# Run workflow with new model
c:/idt/idt.exe workflow images \
    --provider claude \
    --model claude-opus-4-20250514 \  # Different model!
    --prompt-style narrative \
    --name yourproject \
    --output-dir descriptions \
    --api-key-file ~/.config/idt/claude.txt \
    --batch

# Regenerate JSON (will include new model)
python ../generate_descriptions.py \
    --descriptions-dir descriptions \
    --output-dir descriptions \
    --pattern yourproject
```

---

## Success Criteria

A gallery is complete and deployment-ready when:

✅ **Data Complete**
- All 4 workflow directories exist
- All description files >30KB
- All JSON files have alt_text field
- index.json lists all configurations

✅ **Functionality Works**
- Gallery loads without errors
- All images display
- Both view modes work
- Keyboard navigation works
- Prompt text toggle works

✅ **Accessibility Ready**
- Alt text on all images
- Keyboard accessible
- Screen reader compatible
- Sufficient color contrast

✅ **Documentation Present**
- Know which model was used
- Know when descriptions generated
- Have backup of source images
- Workflow logs preserved

---

## Next Steps After This Guide

1. **Create your first gallery** following this guide exactly
2. **Document any issues** you encounter
3. **Update this guide** with solutions
4. **Create automation script** once confident in process
5. **Share process** with team if applicable

---

## Quick Command Reference

**Complete gallery creation in one place:**

```bash
# Phase 1: Setup
mkdir -p yourproject/{images,gallery-data,analysis}
cp /source/images/*.jpg yourproject/images/

# Copy utility scripts
cd tools/ImageGallery
cp export_analysis_data.py check_data_status.py yourproject/

# Phase 2: Run workflows (repeat for narrative, colorful, technical, detailed)
cd yourproject
c:/idt/idt.exe workflow images/ \
  --provider claude \
  --model claude-3-haiku-20240307 \
  --prompt-style narrative \
  --name yourproject \
  --output-dir descriptions \
  --api-key-file ~/.config/idt/claude.txt \
  --batch

# Phase 3: Generate JSON (IMPORTANT: separate directory!)
python ../generate_descriptions.py \
  --descriptions-dir descriptions \
  --output-dir gallery-data \
  --pattern yourproject

# Phase 4: Add alt text
export ANTHROPIC_API_KEY=$(cat ~/.config/idt/claude.txt)
python ../generate_alt_text.py --jsondata-dir gallery-data/

# Phase 5: Configure and test
cp ../index.html .
# Edit index.html: CONFIG.descriptionsBaseUrl = './gallery-data/'
python -m http.server 8082

# Optional: Export analysis data
python export_analysis_data.py \
  --descriptions-dir descriptions \
  --output-dir analysis \
  --pattern yourproject
# Creates: analysis/image_analysis_data_YYYYMMDD_HHMMSS.csv

# Deploy: Copy ONLY these to web server
# ✅ index.html (~95KB)
# ✅ images/ (~50-100MB)
# ✅ gallery-data/ (~150KB)
# ❌ descriptions/wf_*/ (~130MB) - DO NOT DEPLOY!
# ❌ analysis/ - Optional, keep local for reference
```

---

## Directory Size Reference

**What takes up space and what to deploy:**

| Directory | Contents | Size | Deploy? |
|-----------|----------|------|---------|
| `images/` | JPG files | 50-100MB | ✅ Yes |
| `gallery-data/` | JSON files | ~150KB | ✅ Yes |
| `index.html` | Gallery UI | ~95KB | ✅ Yes |
| `descriptions/wf_*/` | Workflow logs | ~130MB | ❌ No |
| **Total to Deploy** | | **~50-100MB** | |
| **If you copy descriptions/** | | **~230MB** | ❌ **Wrong!** |

**Common Mistake:** Copying entire `descriptions/` directory wastes 130MB on workflow logs that the gallery doesn't use.

---

**Last Updated:** October 25, 2025  
**Based On:** Successful `contentprototype` gallery creation  
**Author:** AI-assisted documentation from real workflow
